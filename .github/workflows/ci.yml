name: JSOS CI/CD

on:
  push:
    branches: [ main, master, maybe_bad ]
  pull_request:
    branches: [ main, master, maybe_bad ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build JSOS
      run: |
        docker build -f docker/build.Dockerfile -t jsos-build .
        docker create --name temp-jsos jsos-build /bin/true
        docker cp temp-jsos:/jsos.iso build/jsos.iso
        docker rm temp-jsos

    - name: Install QEMU
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-system-x86 qemu-system-gui

    - name: Run Automated Test
      run: |
        mkdir -p test-output
        timeout 60s qemu-system-x86_64 -cdrom build/jsos.iso -m 512M -no-reboot -nographic > test-output/test.log 2>&1 || true

    - name: Analyze Test Results
      run: |
        if [ -f test-output/test.log ]; then
          echo "=== Test Log ==="
          cat test-output/test.log
          echo "=== Analysis ==="
          if grep -q "System boot complete\|JSOS\|Welcome to" test-output/test.log; then
            echo "✅ Boot Status: SUCCESS"
          else
            echo "❌ Boot Status: FAILED"
          fi
          if grep -q "SyntaxError\|parse error\|ReferenceError\|TypeError" test-output/test.log; then
            echo "❌ JavaScript Errors: FOUND"
            grep -n "SyntaxError\|parse error\|ReferenceError\|TypeError" test-output/test.log
            exit 1
          else
            echo "✅ JavaScript Errors: NONE"
          fi
        else
          echo "❌ No test log found"
          exit 1
        fi

    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          test-output/
          build/jsos.iso